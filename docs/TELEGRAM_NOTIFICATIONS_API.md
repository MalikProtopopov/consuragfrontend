# Telegram Notifications API

Документация для фронтенд разработчиков по интеграции системы Telegram уведомлений.

## Обзор системы

Система использует **два Telegram-бота**:

| Бот | Назначение | Получатели |
|-----|------------|------------|
| **Admin Bot** | Уведомления о заявках, регистрациях, отчёты | SAAS_ADMIN (группа/чат) |
| **User Bot** | Уведомления о лимитах и подписках | OWNER-пользователи (личные сообщения) |

---

## API Endpoints

### Для OWNER пользователей

#### 1. Сгенерировать код привязки Telegram

```
POST /api/v1/notifications/telegram/link
```

**Требует:** JWT токен (OWNER роль)

**Response (200 OK):**
```json
{
  "code": "ABC123",
  "expires_in": 900,
  "bot_username": "YourNotifyBot",
  "bot_link": "https://t.me/YourNotifyBot?start=ABC123"
}
```

**Ошибки:**
- `409 Conflict` — Telegram уже привязан
- `429 Too Many Requests` — слишком частые запросы (раз в 5 минут)
- `503 Service Unavailable` — User Bot не настроен

**Использование на фронте:**
1. Показать код `ABC123` пользователю
2. Показать кнопку/ссылку `bot_link` для перехода в Telegram
3. Отобразить таймер обратного отсчёта (`expires_in` секунд)

---

#### 2. Отвязать Telegram

```
DELETE /api/v1/notifications/telegram/link
```

**Требует:** JWT токен

**Response:** `204 No Content`

**Ошибки:**
- `404 Not Found` — Telegram не привязан

---

#### 3. Получить статус привязки

```
GET /api/v1/notifications/telegram/status
```

**Требует:** JWT токен

**Response (200 OK):**
```json
{
  "linked": true,
  "username": "@username",
  "notifications_enabled": true,
  "linked_at": "2026-01-11T12:00:00Z"
}
```

---

#### 4. Включить/выключить уведомления

```
PUT /api/v1/notifications/telegram/notifications
```

**Требует:** JWT токен

**Request Body:**
```json
{
  "enabled": true
}
```

**Response:** `204 No Content`

**Ошибки:**
- `404 Not Found` — Telegram не привязан

---

### Для SAAS_ADMIN

#### 1. Получить конфигурацию ботов

```
GET /api/v1/notifications/admin/telegram/config
```

**Требует:** JWT токен (SAAS_ADMIN роль)

**Response (200 OK):**
```json
{
  "admin_bot_configured": true,
  "admin_bot_username": "AdminNotifyBot",
  "admin_chat_id_configured": true,
  "user_bot_configured": true,
  "user_bot_username": "UserNotifyBot",
  "webhook_configured": true,
  "webhook_url": "https://api.example.com/api/v1/notifications/webhook/xxx"
}
```

---

#### 2. Настроить Admin Bot

```
PUT /api/v1/notifications/admin/telegram/admin-bot
```

**Request Body:**
```json
{
  "bot_token": "123456789:ABCdefGHIjklMNOpqrsTUVwxyz",
  "chat_id": "-1001234567890"
}
```

**Response:** `204 No Content`

**Важно:**
- Бот должен быть добавлен в чат
- Бот должен иметь права на отправку сообщений

---

#### 3. Настроить User Bot

```
PUT /api/v1/notifications/admin/telegram/user-bot
```

**Request Body:**
```json
{
  "bot_token": "123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
}
```

**Response:** `204 No Content`

**Важно:**
- `PUBLIC_API_URL` должен быть настроен в env
- Webhook автоматически регистрируется на Telegram

---

#### 4. Отправить тестовое сообщение

```
POST /api/v1/notifications/admin/telegram/test
```

**Request Body:**
```json
{
  "bot_type": "admin"
}
```

или

```json
{
  "bot_type": "user"
}
```

**Response:** `204 No Content`

**Примечание:** Для `"user"` сообщение отправляется текущему пользователю (SAAS_ADMIN), если у него привязан Telegram.

---

#### 5. Получить логи уведомлений

```
GET /api/v1/notifications/admin/notifications/logs
```

**Query параметры:**
| Параметр | Тип | Описание |
|----------|-----|----------|
| `skip` | int | Пропустить записей (default: 0) |
| `limit` | int | Записей на странице (default: 50, max: 100) |
| `type` | string | Фильтр по типу уведомления |
| `recipient_type` | string | `"admin"` или `"user"` |
| `status` | string | `"pending"`, `"sent"`, `"failed"` |

**Response (200 OK):**
```json
{
  "items": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "notification_type": "new_plan_request",
      "recipient_type": "admin",
      "recipient_id": null,
      "channel": "telegram",
      "status": "sent",
      "message_preview": "#заявка #plan_upgrade\n\n📝 Новая заявка...",
      "error_message": null,
      "created_at": "2026-01-11T12:00:00Z",
      "metadata": {
        "request_type": "plan_upgrade",
        "user_id": "xxx"
      }
    }
  ],
  "total": 150,
  "skip": 0,
  "limit": 50
}
```

---

## Типы уведомлений (notification_type)

### Уведомления пользователям (recipient_type: "user")

| Тип | Описание | Когда отправляется |
|-----|----------|-------------------|
| `limit_warning_80` | Предупреждение о 80% лимита | Достигнут порог 80% |
| `limit_warning_90` | Предупреждение о 90% лимита | Достигнут порог 90% |
| `limit_exceeded` | Лимит исчерпан | Достигнут 100% лимита |
| `subscription_expiring_7d` | Подписка истекает через 7 дней | За 7 дней |
| `subscription_expiring_3d` | Подписка истекает через 3 дня | За 3 дня |
| `subscription_expiring_1d` | Подписка истекает завтра | За 1 день |
| `subscription_expired` | Подписка истекла | В день окончания |
| `plan_changed` | Тариф изменён | При смене тарифа |
| `bonus_tokens_added` | Начислены бонусные токены | При начислении бонусов |

### Уведомления администратору (recipient_type: "admin")

| Тип | Описание | Когда отправляется |
|-----|----------|-------------------|
| `new_plan_request` | Новая заявка | При создании заявки |
| `new_user_registered` | Новый пользователь | При регистрации |
| `user_limit_exceeded` | Пользователь исчерпал лимит | При 100% лимита |
| `daily_report` | Ежедневный отчёт | Каждый день в 10:00 |
| `weekly_report` | Еженедельный отчёт | Пятница в 18:00 |

---

## UI компоненты

### Для SAAS Admin: Страница настройки ботов

```
/admin/settings/telegram-notifications
```

**Рекомендуемая структура:**

1. **Секция Admin Bot**
   - Поле ввода токена бота
   - Поле ввода Chat ID
   - Статус: настроен/не настроен
   - Кнопка "Сохранить"
   - Кнопка "Тест" (отправить тестовое сообщение)

2. **Секция User Bot**
   - Поле ввода токена бота
   - Статус webhook
   - Кнопка "Сохранить"
   - Кнопка "Тест"

3. **Таблица логов уведомлений**
   - Фильтры: тип, статус, период
   - Колонки: дата, тип, получатель, статус
   - Пагинация

### Для OWNER: Секция в профиле

```
/settings/notifications
```

**Рекомендуемая структура:**

1. **Блок "Telegram уведомления"**
   - Если не привязан:
     - Кнопка "Привязать Telegram"
     - При нажатии: показать код и ссылку на бота
     - Таймер обратного отсчёта (15 минут)
   - Если привязан:
     - Показать username (`@username`)
     - Дата привязки
     - Переключатель вкл/выкл уведомлений
     - Кнопка "Отвязать"

2. **Информация о типах уведомлений**
   - Список того, о чём будут приходить уведомления

---

## Flow привязки Telegram

```
┌─────────────────────────────────────────┐
│ 1. Пользователь нажимает               │
│    "Привязать Telegram"                 │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 2. Frontend вызывает                    │
│    POST /api/v1/notifications/telegram/link │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 3. Показать модальное окно:            │
│    - Код: ABC123                        │
│    - Ссылка на бота                     │
│    - Таймер 15 минут                    │
│    - QR-код (опционально)               │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 4. Пользователь переходит в Telegram   │
│    и отправляет /start ABC123          │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 5. Бот отвечает "Привязка успешна!"    │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 6. Frontend периодически проверяет     │
│    GET /api/v1/notifications/telegram/status │
│    или пользователь закрывает модал    │
└─────────────────────────────────────────┘
```

---

## Примеры сообщений в Telegram

### Admin: Новая заявка

```
#заявка #plan_upgrade

📝 Новая заявка: повышение тарифа
━━━━━━━━━━━━━━━━━━━━━━
👤 Пользователь: user@example.com
📊 Текущий план: starter
🎯 Желаемый план: growth

📞 Контакты:
  • Email: user@example.com
  • Telegram: @username

💬 Сообщение: Хочу больше токенов для проекта
━━━━━━━━━━━━━━━━━━━━━━
```

### User: Предупреждение о лимитах

```
⚠️ Предупреждение о лимитах

Вы использовали 80.5% лимита токенов (chat).

📊 Использовано: 80,500 из 100,000

Рекомендуем повысить тарифный план, чтобы избежать ограничений.

Аккаунт: user@example.com
```

---

## Безопасность

1. **Токены ботов** — хранятся зашифрованными, никогда не возвращаются через API
2. **Webhook** — защищён секретным токеном в URL
3. **Доступ** — только SAAS_ADMIN может настраивать ботов
4. **One-time code** — 6 символов, срок жизни 15 минут, rate limit 5 минут

---

## Хештеги для фильтрации (Admin Bot)

Все уведомления админу содержат хештеги для удобной фильтрации в Telegram:

| Хештег | Тип события |
|--------|-------------|
| `#заявка` | Любая заявка |
| `#plan_upgrade` | Заявка на повышение тарифа |
| `#demo_request` | Запрос демо |
| `#contact_sales` | Связь с отделом продаж |
| `#регистрация` | Новый пользователь |
| `#new_user` | Новый пользователь |
| `#лимит` | Превышение лимита |
| `#limit_exceeded` | Превышение лимита |
| `#отчёт` | Ежедневный/еженедельный отчёт |
| `#daily` | Ежедневный отчёт |
| `#weekly` | Еженедельный отчёт |

---

## Расписание автоматических уведомлений

| Задача | Время | Описание |
|--------|-------|----------|
| Проверка подписок | 09:00 ежедневно | Уведомления за 7, 3, 1 день до окончания |
| Ежедневный отчёт | 10:00 ежедневно | Отчёт за предыдущий день |
| Еженедельный отчёт | 18:00 пятница | Отчёт за неделю |

---

## Типичные ошибки

| Код | Сообщение | Решение |
|-----|-----------|---------|
| `409` | Telegram уже привязан | Отвязать старый аккаунт |
| `429` | Слишком частые запросы | Подождать 5 минут |
| `404` | Telegram не привязан | Сначала привязать аккаунт |
| `503` | Bot not configured | Админ должен настроить бота |

